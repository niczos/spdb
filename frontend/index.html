<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Route finder</title>
	<link rel="icon" href="favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css" />
	<script src="node_modules/leaflet/dist/leaflet.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwykCGz1eLwNOJ-u_5b4B7f_gjO8AH_34&libraries=places"></script>
	<style>
		#map {
			height: 600px;
			width: 60%;
		}
	</style>
</head>
<body>
	<div id="map"></div>
	<form>
		<label for="address">Address:</label>
		<input type="text" id="address" name="address">
		<button type="button" onclick="geocodeAddress()">Geocode</button>

		<label for="sourceLatitude">Source Latitude:</label>
		<input type="text" id="sourceLatitude" name="sourceLatitude" readonly>
	
		<label for="sourceLongitude">Source Longitude:</label>
		<input type="text" id="sourceLongitude" name="sourceLongitude" readonly>
	
		<label for="destinationLatitude">Destination Latitude:</label>
		<input type="text" id="destinationLatitude" name="destinationLatitude" readonly>
	
		<label for="destinationLongitude">Destination Longitude:</label>
		<input type="text" id="destinationLongitude" name="destinationLongitude" readonly>
	
		<label for="speedLimit">Speed Limit (numbers only):</label>
		<input type="number" id="speedLimit" name="speedLimit">

		<input type="submit" value="Submit Route">
	</form>
	<script>
		const map = L.map('map', {
			center: [52, 19],
			zoom: 6
		});
		
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
			maxZoom: 18
		}).addTo(map);

		let sourceMarker = null;
		let destinationMarker = null;
		let isSourceSet = false;

		const sourceLatitudeInput = document.getElementById('sourceLatitude');
		const sourceLongitudeInput = document.getElementById('sourceLongitude');
		const destinationLatitudeInput = document.getElementById('destinationLatitude');
		const destinationLongitudeInput = document.getElementById('destinationLongitude');
		const speedLimitInput = document.getElementById('speedLimit');

		function geocodeAddress() {
			const address = document.getElementById('address').value;
			const geocoder = new google.maps.Geocoder();

			geocoder.geocode({ address }, (results, status) => {
				if (status === google.maps.GeocoderStatus.OK) {
					const location = results[0].geometry.location;
					const lat = location.lat();
					const lng = location.lng();

					console.log('Geocoding result:', results[0]);

					sourceLatitudeInput.value = lat;
					sourceLongitudeInput.value = lng;
				} else {
					console.error('Geocoding error:', status);
				}
			});
		}

		function submitForm(event) {
			event.preventDefault();

			const formData = {
				sourceLatitude: sourceLatitudeInput.value,
				sourceLongitude: sourceLongitudeInput.value,
				destinationLatitude: destinationLatitudeInput.value,
				destinationLongitude: destinationLongitudeInput.value,
				speedLimit: speedLimitInput.value
			};

			fetch('http://127.0.0.1:5000/get_route', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(formData),
			})
			.then(response => response.json())
			.then(data => {
				console.log('Server response:', data);
			})
			.catch(error => {
				console.error('Error sending data to server:', error);
			});
		}

		map.on('click', function (e) {
			if (!isSourceSet) {
				if (sourceMarker) {
					map.removeLayer(sourceMarker);
				}
				sourceMarker = L.marker(e.latlng).addTo(map);
				alert("Source set at latitude: " + e.latlng.lat + ", longitude: " + e.latlng.lng);
				sourceLat = e.latlng.lat;
				sourceLng = e.latlng.lng;

				sourceLatitudeInput.setAttribute('value', e.latlng.lat);
            	sourceLongitudeInput.setAttribute('value', e.latlng.lng);

				isSourceSet = true;
			} else {
				if (destinationMarker) {
					map.removeLayer(destinationMarker);
				}
				destinationMarker = L.marker(e.latlng).addTo(map);
				alert("Destination set at latitude: " + e.latlng.lat + ", longitude: " + e.latlng.lng);
				destinationLat = e.latlng.lat;
				destinationLng = e.latlng.lng;

				destinationLatitudeInput.setAttribute('value', e.latlng.lat);
            	destinationLongitudeInput.setAttribute('value', e.latlng.lng);

				isSourceSet = false;
			}
		});
	</script>
</body>
</html>